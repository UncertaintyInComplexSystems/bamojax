
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://uncertaintyincomplexsystems.github.io/bamojax/api/bamojax.samplers/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>bamojax.samplers - BaMoJAX</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bamojaxsamplers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="BaMoJAX" class="md-header__button md-logo" aria-label="BaMoJAX" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BaMoJAX
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              bamojax.samplers
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/UncertaintyInComplexSystems/bamojax" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    UncertaintyInComplexSystems/bamojax
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="BaMoJAX" class="md-nav__button md-logo" aria-label="BaMoJAX" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    BaMoJAX
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/UncertaintyInComplexSystems/bamojax" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    UncertaintyInComplexSystems/bamojax
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bamojax.samplers" class="md-nav__link">
    <span class="md-ellipsis">
      samplers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bamojax.samplers.gibbs_sampler" class="md-nav__link">
    <span class="md-ellipsis">
      gibbs_sampler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bamojax.samplers.mcmc_sampler" class="md-nav__link">
    <span class="md-ellipsis">
      mcmc_sampler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bamojax.samplers.reversible_jump_mcmc" class="md-nav__link">
    <span class="md-ellipsis">
      reversible_jump_mcmc
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="bamojaxsamplers"><code>bamojax.samplers</code><a class="headerlink" href="#bamojaxsamplers" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<a id="bamojax.samplers"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="bamojax.samplers.gibbs_sampler" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">gibbs_sampler</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">step_fns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_fn_params</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#bamojax.samplers.gibbs_sampler" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Constructs a Gibbs sampler as a Blackjax SamplingAlgorithm.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="bamojax.base.Model" href="../#bamojax.base.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The bamojax definition of a Bayesian model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>step_fns</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(optional) a set of step functions to use for updating each variable in turn.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>step_fn_params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(optional) parameters of the step functions</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="blackjax.base.SamplingAlgorithm">SamplingAlgorithm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A SamplingAlgorithm object. This can be used to call the respective .init and .step functions in the inference routines.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>bamojax/samplers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gibbs_sampler</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> 
                  <span class="n">step_fns</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                  <span class="n">step_fn_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SamplingAlgorithm</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot; Constructs a Gibbs sampler as a Blackjax SamplingAlgorithm.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: The bamojax definition of a Bayesian model.</span>
<span class="sd">        step_fns: (optional) a set of step functions to use for updating each variable in turn.</span>
<span class="sd">        step_fn_params: (optional) parameters of the step functions</span>

<span class="sd">    Returns:</span>
<span class="sd">        A SamplingAlgorithm object. This can be used to call the respective .init and .step functions in the inference routines.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_step_fns_defaults</span><span class="p">(</span><span class="n">step_fns</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">step_fn_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot; Set the step function of each node if not specified. Defaults to a Gaussian random walk with a stepsize of 0.01.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">step_fns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">step_fns</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No step functions found; setting defaults.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">step_fn_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">step_fn_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">sorted_free_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_node_order</span><span class="p">()</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_stochastic</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_observed</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">step_fns</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">sorted_free_variables</span><span class="p">:</span>
            <span class="n">step_fns</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">normal_random_walk</span>
            <span class="n">num_elem</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span> <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">step_fn_params</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">0.01</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_elem</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">step_fns</span><span class="p">,</span> <span class="n">step_fn_params</span>

    <span class="c1">#</span>
    <span class="n">step_fns</span><span class="p">,</span> <span class="n">step_fn_params</span> <span class="o">=</span> <span class="n">set_step_fns_defaults</span><span class="p">(</span><span class="n">step_fns</span><span class="o">=</span><span class="n">step_fns</span><span class="p">,</span> <span class="n">step_fn_params</span><span class="o">=</span><span class="n">step_fn_params</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_nonstandard_gibbs_step</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> 
                                   <span class="n">position</span><span class="p">,</span> 
                                   <span class="n">loglikelihood_fn</span><span class="p">,</span> 
                                   <span class="n">step_fns</span><span class="p">,</span> 
                                   <span class="n">step_fn_params</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot; The Blackjax SamplingAlgorithm is not parametrized in entirely the same way for different algorithms. To not clutter the gibbs_fn, exception cases are handled here.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">get_mean</span><span class="p">()</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">get_cov</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">step_fn_params</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;elliptical_slice&#39;</span><span class="p">:</span>                    
            <span class="n">step_kernel</span> <span class="o">=</span> <span class="n">step_fns</span><span class="p">[</span><span class="n">node</span><span class="p">](</span><span class="n">loglikelihood_fn</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">)</span>
            <span class="n">step_substate</span> <span class="o">=</span> <span class="n">step_kernel</span><span class="o">.</span><span class="n">init</span><span class="p">({</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="n">node</span><span class="p">]})</span>  
        <span class="k">elif</span> <span class="n">step_fn_params</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;elliptical_slice_nd&#39;</span><span class="p">:</span>                     
            <span class="n">nd</span> <span class="o">=</span> <span class="n">step_fn_params</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;nd&#39;</span><span class="p">]</span>
            <span class="n">step_kernel</span> <span class="o">=</span> <span class="n">step_fns</span><span class="p">[</span><span class="n">node</span><span class="p">](</span><span class="n">loglikelihood_fn</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="n">nd</span><span class="p">)</span>
            <span class="n">step_substate</span> <span class="o">=</span> <span class="n">step_kernel</span><span class="o">.</span><span class="n">init</span><span class="p">({</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="n">node</span><span class="p">]})</span>  
        <span class="k">elif</span> <span class="n">step_fn_params</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mgrad_gaussian&#39;</span><span class="p">:</span>
            <span class="c1"># see issue https://github.com/blackjax-devs/blackjax/issues/237,mgrad does not seem robust yet</span>
            <span class="n">loglikelihood_fn_mgrad</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="n">loglikelihood_fn</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
            <span class="n">step_kernel</span> <span class="o">=</span> <span class="n">step_fns</span><span class="p">[</span><span class="n">node</span><span class="p">](</span><span class="n">logdensity_fn</span><span class="o">=</span><span class="n">loglikelihood_fn_mgrad</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">covariance</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span> <span class="o">**</span><span class="n">step_fn_params</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
            <span class="n">step_substate</span> <span class="o">=</span> <span class="n">step_kernel</span><span class="o">.</span><span class="n">init</span><span class="p">({</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]})</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="n">step_kernel</span><span class="p">,</span> <span class="n">step_substate</span>

    <span class="c1">#</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gibbs_fn</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> 
                 <span class="n">key</span><span class="p">,</span> 
                 <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot; Updates each latent variable given the current assignment of all other latent variables, according to the assigned step functions.</span>

<span class="sd">        The signature of the Gibbs function is (key, state, temperature) -&gt; (state, info)</span>

<span class="sd">        The Gibbs densities are defined as follows. Let Pa(x) give the parents of the set of variables x, and let Ch(x) give the set of children. Then the density is given by:</span>

<span class="sd">        p(x | Pa(x)) \propto p(Ch(x) | Pa(Ch(x))) p(x | Pa(x))</span>

<span class="sd">        Args:</span>
<span class="sd">            key: PRNGKey</span>
<span class="sd">            state: The current assignment of all latent variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            state: The updated assignment of all latent variables.</span>
<span class="sd">            info: Additional information regarding the updates for every latent variable, such as acceptance rates.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># In case we apply likelihood tempering</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sorted_free_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_node_order</span><span class="p">()</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_stochastic</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_observed</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">sorted_free_variables</span><span class="p">:</span>
            <span class="c1"># Get conditional densities</span>
            <span class="n">conditionals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>        
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="c1"># Co-parents are all parents of the child, except node</span>
                <span class="n">co_parents</span> <span class="o">=</span> <span class="p">{</span><span class="n">parent</span> <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_parents</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">node</span><span class="p">}</span>

                <span class="c1"># Values for co-parents are either taken from the position (if latent), or from their respective observations (if observed)</span>
                <span class="n">co_parent_arguments</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">position</span> <span class="k">else</span> <span class="n">k</span><span class="o">.</span><span class="n">observations</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">co_parents</span><span class="p">}</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">loglikelihood_fn_</span><span class="p">(</span><span class="n">substate</span><span class="p">):</span>
                    <span class="n">dynamic_state</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">co_parent_arguments</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">substate</span><span class="p">[</span><span class="n">node</span><span class="p">]}</span>
                    <span class="n">child_value</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">observations</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">()</span> <span class="k">else</span> <span class="n">position</span><span class="p">[</span><span class="n">child</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">child</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">dynamic_state</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">child_value</span><span class="p">)</span>

                <span class="c1">#            </span>
                <span class="n">co_parents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="n">conditionals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loglikelihood_fn_</span><span class="p">)</span>

            <span class="n">loglikelihood_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">temperature</span><span class="o">*</span><span class="n">ll_fn</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">ll_fn</span> <span class="ow">in</span> <span class="n">conditionals</span><span class="p">]))</span>

            <span class="k">if</span> <span class="s1">&#39;implied_mvn_prior&#39;</span> <span class="ow">in</span> <span class="n">step_fn_params</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
                <span class="c1"># Some Blackjax step functions are tailored to multivariate Gaussian priors.</span>
                <span class="n">step_kernel</span><span class="p">,</span> <span class="n">step_substate</span> <span class="o">=</span> <span class="n">get_nonstandard_gibbs_step</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">loglikelihood_fn</span><span class="p">,</span> <span class="n">step_fns</span><span class="p">,</span> <span class="n">step_fn_params</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logprior_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">substate</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">substate</span><span class="p">[</span><span class="n">node</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
                <span class="n">logdensity_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">substate_</span><span class="p">:</span> <span class="n">loglikelihood_fn</span><span class="p">(</span><span class="n">substate_</span><span class="p">)</span> <span class="o">+</span> <span class="n">logprior_fn</span><span class="p">(</span><span class="n">substate_</span><span class="p">)</span>
                <span class="n">step_kernel</span> <span class="o">=</span> <span class="n">step_fns</span><span class="p">[</span><span class="n">node</span><span class="p">](</span><span class="n">logdensity_fn</span><span class="p">,</span> <span class="o">**</span><span class="n">step_fn_params</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>   
                <span class="n">step_substate</span> <span class="o">=</span> <span class="n">step_kernel</span><span class="o">.</span><span class="n">init</span><span class="p">({</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="n">node</span><span class="p">]})</span>   

            <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jrnd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>     
            <span class="c1"># [TODO]: add functionality to sample specific variables for different numbers of steps</span>
            <span class="c1"># def step_body(key, state): step_kernel.step...</span>
            <span class="c1"># step_substate, step_info = jax.lax.scan(step_body, keys, state)</span>
            <span class="n">step_substate</span><span class="p">,</span> <span class="n">step_info</span> <span class="o">=</span> <span class="n">step_kernel</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">step_substate</span><span class="p">)</span>
            <span class="n">info</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_info</span>

            <span class="n">position</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">position</span><span class="p">,</span> <span class="o">**</span><span class="n">step_substate</span><span class="o">.</span><span class="n">position</span><span class="p">}</span>

            <span class="k">del</span> <span class="n">step_kernel</span>
            <span class="k">del</span> <span class="n">step_substate</span>
            <span class="k">del</span> <span class="n">conditionals</span>
            <span class="k">del</span> <span class="n">children</span>

        <span class="k">del</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">GibbsState</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">),</span> <span class="n">info</span>

    <span class="c1">#</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_fn</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">rng_key</span>
        <span class="k">return</span> <span class="n">GibbsState</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">step_fn</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">PRNGKey</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">gibbs_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span>

    <span class="c1">#</span>
    <span class="n">step_fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;gibbs_step_fn&#39;</span>
    <span class="k">return</span> <span class="n">SamplingAlgorithm</span><span class="p">(</span><span class="n">init_fn</span><span class="p">,</span> <span class="n">step_fn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="bamojax.samplers.mcmc_sampler" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mcmc_sampler</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">mcmc_kernel</span><span class="p">,</span> <span class="n">mcmc_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#bamojax.samplers.mcmc_sampler" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Constructs an MCMC sampler from a given Blackjax algorithm.</p>
<p>This lightweight wrapper ensures the (optional) tempering parameter 'temperature',
as part of the keyword-arguments of step_fn(..., **kwargs), is passed correctly.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="bamojax.base.Model" href="../#bamojax.base.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A bamojax model definition.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mcmc_kernel</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A Blackjax MCMC algorithm.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mcmc_parameters</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional Blackjax MCMC parameters, such as step sizes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    A Blackjax SamplingAlgorithm object with methods <code>init_fn</code> and <code>step_fn</code>.</p>


            <details class="quote">
              <summary>Source code in <code>bamojax/samplers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mcmc_sampler</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> 
                 <span class="n">mcmc_kernel</span><span class="p">,</span> 
                 <span class="n">mcmc_parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Constructs an MCMC sampler from a given Blackjax algorithm.</span>

<span class="sd">    This lightweight wrapper ensures the (optional) tempering parameter &#39;temperature&#39;,</span>
<span class="sd">    as part of the keyword-arguments of step_fn(..., **kwargs), is passed correctly.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: A bamojax model definition.</span>
<span class="sd">        mcmc_kernel: A Blackjax MCMC algorithm.</span>
<span class="sd">        mcmc_parameters: Optional Blackjax MCMC parameters, such as step sizes.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A Blackjax SamplingAlgorithm object with methods `init_fn` and `step_fn`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mcmc_fn</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> 
                <span class="n">key</span><span class="p">,</span> 
                <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> 
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">apply_mcmc_kernel</span><span class="p">(</span><span class="n">key_</span><span class="p">,</span> <span class="n">logdensity_fn</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
            <span class="n">kernel_instance</span> <span class="o">=</span> <span class="n">mcmc_kernel</span><span class="p">(</span><span class="n">logdensity_fn</span><span class="o">=</span><span class="n">logdensity_fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mcmc_parameters</span><span class="p">)</span>
            <span class="n">state_</span> <span class="o">=</span> <span class="n">kernel_instance</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">state_</span><span class="p">,</span> <span class="n">info_</span> <span class="o">=</span> <span class="n">kernel_instance</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">key_</span><span class="p">,</span> <span class="n">state_</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">state_</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">info_</span>

        <span class="c1">#</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">loglikelihood_fn_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">loglikelihood_fn</span><span class="p">()</span>
        <span class="n">logprior_fn_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">logprior_fn</span><span class="p">()</span>
        <span class="n">tempered_logdensity_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">temperature</span> <span class="o">*</span> <span class="n">loglikelihood_fn_</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="n">logprior_fn_</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
        <span class="n">new_position</span><span class="p">,</span> <span class="n">mcmc_info</span> <span class="o">=</span> <span class="n">apply_mcmc_kernel</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tempered_logdensity_fn</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MCMCState</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">new_position</span><span class="p">),</span> <span class="n">mcmc_info</span>

    <span class="c1">#</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_fn</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">rng_key</span>
        <span class="k">return</span> <span class="n">MCMCState</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">step_fn</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">PRNGKey</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">mcmc_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span>

    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">SamplingAlgorithm</span><span class="p">(</span><span class="n">init_fn</span><span class="p">,</span> <span class="n">step_fn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="bamojax.samplers.reversible_jump_mcmc" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reversible_jump_mcmc</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">auxiliary_proposal_dist</span><span class="p">,</span> <span class="n">jump_functions</span><span class="p">,</span> <span class="n">jacobians</span><span class="p">,</span> <span class="n">projections</span><span class="p">,</span> <span class="n">within_model_kernels</span><span class="p">,</span> <span class="n">model_move_prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code>

<a href="#bamojax.samplers.reversible_jump_mcmc" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Constructs a reversible jump MCMC algorithm for the given models.</p>
<p>Implementation follows the reversible jump MCMC algorithm described by Hastie &amp; Green (2012).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>models</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="bamojax.base.Model" href="../#bamojax.base.Model">Model</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of models to sample from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>auxiliary_proposal_dist</code>
            </td>
            <td>
                  <code><span title="distrax.Distribution">Distribution</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Distribution to sample the auxiliary variable from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>jump_functions</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of functions to transform the position when jumping between models.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>jacobians</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Jacobian determinant functions for the jump functions</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>within_model_kernel</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of within-model sampling algorithms, one for each model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SamplingAlgorithm</code></td>            <td>
                  <code><span title="blackjax.base.SamplingAlgorithm">SamplingAlgorithm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sampling algorithm that implements the reversible jump MCMC.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="references" open>
  <summary>References</summary>
  <p>Hastie, T., &amp; Green, P. J. (2012). Model choice using reversible jump Markov chain Monte Carlo</p>
</details>

            <details class="quote">
              <summary>Source code in <code>bamojax/samplers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reversible_jump_mcmc</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Model</span><span class="p">],</span> 
                         <span class="n">auxiliary_proposal_dist</span><span class="p">:</span> <span class="n">Distribution</span><span class="p">,</span>
                         <span class="n">jump_functions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">],</span>
                         <span class="n">jacobians</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">],</span>
                         <span class="n">projections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">],</span>
                         <span class="n">within_model_kernels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
                         <span class="n">model_move_prob</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SamplingAlgorithm</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructs a reversible jump MCMC algorithm for the given models.</span>

<span class="sd">    Implementation follows the reversible jump MCMC algorithm described by Hastie &amp; Green (2012).</span>

<span class="sd">    Args:</span>
<span class="sd">        models: List of models to sample from.</span>
<span class="sd">        auxiliary_proposal_dist: Distribution to sample the auxiliary variable from.</span>
<span class="sd">        jump_functions: List of functions to transform the position when jumping between models.</span>
<span class="sd">        jacobians: List of Jacobian determinant functions for the jump functions</span>
<span class="sd">        within_model_kernel: List of within-model sampling algorithms, one for each model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SamplingAlgorithm: A sampling algorithm that implements the reversible jump MCMC.</span>

<span class="sd">    References:</span>
<span class="sd">        Hastie, T., &amp; Green, P. J. (2012). Model choice using reversible jump Markov chain Monte Carlo</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Reversible jump MCMC currently only supports two models.&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">jump_functions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Reversible jump MCMC requires two jump functions for the two models.&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">jacobians</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Reversible jump MCMC requires two Jacobian determinant functions for the two models.&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">within_model_kernels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Reversible jump MCMC requires within-model sampling algorithms for each models.&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_within_model_kernel</span><span class="p">(</span><span class="n">model_index</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SamplingAlgorithm</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a within-model kernel for the specified model index.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_index: Index of the model for which to create the within-model kernel.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A SamplingAlgorithm that performs within-model sampling for the specified model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">mcmc_sampler</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="n">model_index</span><span class="p">],</span> 
                            <span class="n">mcmc_kernel</span><span class="o">=</span><span class="n">within_model_kernels</span><span class="p">[</span><span class="n">model_index</span><span class="p">][</span><span class="s1">&#39;mcmc_kernel&#39;</span><span class="p">],</span> 
                            <span class="n">mcmc_parameters</span><span class="o">=</span><span class="n">within_model_kernels</span><span class="p">[</span><span class="n">model_index</span><span class="p">][</span><span class="s1">&#39;mcmc_parameters&#39;</span><span class="p">])</span>

    <span class="c1">#    </span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_within_model_fn</span><span class="p">(</span><span class="n">model_index</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">RJState</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a function that performs a within-model move for the specified model index.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_index: Index of the model for which to create the within-model move function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A function that takes a key, position, and optional arguments, and returns a new RJState and info dictionary.</span>
<span class="sd">            The info dictionary imputes nan values for log probabilities and Jacobian determinants, as they are not used in within-model moves.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">fn</span><span class="p">(</span> <span class="n">key</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">mcmc_samplers</span><span class="p">[</span><span class="n">model_index</span><span class="p">]</span>
            <span class="n">initial_position</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">models</span><span class="p">[</span><span class="n">model_index</span><span class="p">]</span><span class="o">.</span><span class="n">get_latent_nodes</span><span class="p">()}</span>            
            <span class="n">within_move_initial_state</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">initial_position</span><span class="p">)</span>
            <span class="n">new_state</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">within_move_initial_state</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
            <span class="n">new_position</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">position</span><span class="p">,</span> <span class="o">**</span><span class="n">new_state</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="s1">&#39;model_index&#39;</span><span class="p">:</span> <span class="n">model_index</span><span class="p">}</span>  
            <span class="k">return</span> <span class="n">RJState</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">new_position</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;within_model_move&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
                                                    <span class="s1">&#39;is_accepted&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">is_accepted</span><span class="p">,</span>
                                                    <span class="s1">&#39;log_accept_ratio&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">acceptance_rate</span><span class="p">),</span>
                                                    <span class="s1">&#39;step_info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;log_p_current&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                                                  <span class="s1">&#39;log_p_proposed&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                                                  <span class="s1">&#39;logq&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                                                  <span class="s1">&#39;jacobian_det&#39;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="c1">#</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_model_logprob</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a function that computes the log probability of the model given a position.&quot;&quot;&quot;</span>

        <span class="n">latent_keys</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_latent_nodes</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">fn</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Position might contain auxiliary variables and variables from other models, so we extract only the correct latent variables.&quot;&quot;&quot;</span>
            <span class="n">model_variables</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">latent_keys</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">loglikelihood_fn</span><span class="p">()(</span><span class="n">model_variables</span><span class="p">)</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">logprior_fn</span><span class="p">()(</span><span class="n">model_variables</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fn</span>

    <span class="c1">#</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reversible_jump_fn</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">PRNGKey</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">RJState</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs a reversible jump MCMC step.</span>

<span class="sd">        Args:</span>
<span class="sd">            key: Random key for sampling.</span>
<span class="sd">            state: Current state of the reversible jump MCMC, containing the model index and position.</span>
<span class="sd">            *args: Additional arguments to pass to the within-model sampling functions. NOT USED</span>
<span class="sd">            **kwargs: Additional keyword arguments to pass to the within-model sampling functions. NOT USED</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing the next state and an info dictionary with details about the move.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">position</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">position</span>
        <span class="n">model_index</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;model_index&#39;</span><span class="p">]</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jrnd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">move_type</span> <span class="o">=</span> <span class="n">jrnd</span><span class="o">.</span><span class="n">bernoulli</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">model_move_prob</span><span class="p">)</span>
        <span class="n">jacobian_det_up</span><span class="p">,</span> <span class="n">jacobian_det_down</span> <span class="o">=</span> <span class="n">jacobians</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">do_within_model</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Perform a standard bamojax within-model move.&quot;&quot;&quot;</span>

            <span class="n">temperature</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">model_index</span><span class="p">,</span> <span class="n">within_model_fns</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">do_between_model</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Perform a reversible jump between models.</span>

<span class="sd">            Currently, there is only support for RJMCMC between two models.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">new_model_index</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">model_index</span>
            <span class="n">key_aux</span><span class="p">,</span> <span class="n">key_accept</span> <span class="o">=</span> <span class="n">jrnd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>            

            <span class="k">def</span><span class="w"> </span><span class="nf">up_branch</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">auxiliary_proposal_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">key_aux</span><span class="p">)</span>
                <span class="n">new_position</span> <span class="o">=</span> <span class="n">jump_functions</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">position</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>  <span class="c1"># make kappa from the auxiliary variable u</span>
                <span class="n">jac_det</span> <span class="o">=</span> <span class="n">jacobian_det_up</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
                <span class="n">logq</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">auxiliary_proposal_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>  <span class="c1"># Note the negative sign! To check: is this robust for other proposal distributions?</span>
                <span class="k">return</span> <span class="n">new_position</span><span class="p">,</span> <span class="n">jac_det</span><span class="p">,</span> <span class="n">logq</span>

            <span class="c1">#</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">down_branch</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
                <span class="n">new_position</span> <span class="o">=</span> <span class="n">jump_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">position</span><span class="p">)</span> <span class="c1"># discard auxiliary variable and kappa</span>
                <span class="n">jac_det</span> <span class="o">=</span> <span class="n">jacobian_det_down</span><span class="p">(</span><span class="n">new_position</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">])</span>
                <span class="n">logq</span> <span class="o">=</span> <span class="n">auxiliary_proposal_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">projections</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">new_position</span><span class="p">))</span> <span class="c1"># log(kappa / mu) where mu is the mean of the auxiliary proposal</span>
                <span class="k">return</span> <span class="n">new_position</span><span class="p">,</span> <span class="n">jac_det</span><span class="p">,</span> <span class="n">logq</span>

            <span class="c1">#</span>
            <span class="n">new_position</span><span class="p">,</span> <span class="n">jac_det</span><span class="p">,</span> <span class="n">logq</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">model_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">up_branch</span><span class="p">,</span> <span class="n">down_branch</span><span class="p">,</span> <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">new_position</span><span class="p">[</span><span class="s1">&#39;model_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_model_index</span>  <span class="c1"># update model index in the new position</span>
            <span class="n">log_p_current</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">model_index</span><span class="p">,</span> <span class="n">model_logprobs</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
            <span class="n">log_p_proposed</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">new_model_index</span><span class="p">,</span> <span class="n">model_logprobs</span><span class="p">,</span> <span class="n">new_position</span><span class="p">)</span>
            <span class="n">log_accept_ratio</span> <span class="o">=</span> <span class="n">log_p_proposed</span> <span class="o">-</span> <span class="n">log_p_current</span> <span class="o">+</span> <span class="n">logq</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jac_det</span><span class="p">)</span> 

            <span class="n">accept</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jrnd</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key_accept</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">log_accept_ratio</span>
            <span class="n">next_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">accept</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">RJState</span><span class="p">(</span><span class="n">new_position</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>       

            <span class="k">return</span> <span class="n">next_state</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;within_model_move&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                                <span class="s1">&#39;is_accepted&#39;</span><span class="p">:</span> <span class="n">accept</span><span class="p">,</span> 
                                <span class="s1">&#39;log_accept_ratio&#39;</span><span class="p">:</span> <span class="n">log_accept_ratio</span><span class="p">,</span>
                                <span class="s1">&#39;step_info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;log_p_current&#39;</span><span class="p">:</span> <span class="n">log_p_current</span><span class="p">,</span>
                                              <span class="s1">&#39;log_p_proposed&#39;</span><span class="p">:</span> <span class="n">log_p_proposed</span><span class="p">,</span>
                                              <span class="s1">&#39;logq&#39;</span><span class="p">:</span> <span class="n">logq</span><span class="p">,</span>
                                              <span class="s1">&#39;jacobian_det&#39;</span><span class="p">:</span> <span class="n">jac_det</span><span class="p">}}</span>

        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">move_type</span><span class="p">,</span> <span class="n">do_within_model</span><span class="p">,</span> <span class="n">do_between_model</span><span class="p">,</span> <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_fn</span><span class="p">(</span><span class="n">position</span><span class="p">:</span> <span class="n">ArrayTree</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">rng_key</span>
        <span class="k">return</span> <span class="n">RJState</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">step_fn</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">PRNGKey</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">reversible_jump_fn</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span>

    <span class="c1">#</span>

    <span class="n">within_model_fns</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_within_model_fn</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))]</span>
    <span class="n">model_logprobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_model_logprob</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
    <span class="n">mcmc_samplers</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_within_model_kernel</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))]</span>

    <span class="n">step_fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;reversible_jump_fn&#39;</span>
    <span class="k">return</span> <span class="n">SamplingAlgorithm</span><span class="p">(</span><span class="n">init_fn</span><span class="p">,</span> <span class="n">step_fn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.top", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>